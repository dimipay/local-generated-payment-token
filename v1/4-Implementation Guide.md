# Implementation Guide

## Common

### Time Synchronization

정확한 카운터 계산을 위해 결제 서버와 클라이언트 간의 시간 오차를 최대한 줄이는 것이 중요합니다.

클라이언트는 기기가 온라인일 떄 NTP 서버를 통해 불러온 네트워크 시각과 기기의 시각을 비교해 오차를 구합니다.
만약 오차가 2000ms를 초과하면 클라이언트는 카운터를 계산할 때 보정된 시각을 사용합니다.

결제 서버도 주기적으로 서버 시각과 네트워크 시각을 비교해 시각을 보정해야합니다.

> [!WARNING]
> 클라이언트와 결제 서버는 같은 NTP 서버를 사용해야합니다.
> 
> 사양에선 [Google public NTP](https://developers.google.com/time) 서버를 기본 NTP 서버로 지정합니다.

3 번 연속으로 복호화에 실패하면 결제 서버는 클라이언트를 "out of sync" 상태로 만들어 더 이상의 결제를 처리하지 않아야 합니다.
클라이언트가 "out of sync" 상태를 해제하기 위해선 인터넷에 연결해 NTP 서버를 이용하여 시각을 보정하고, 결제 서버에 보정된 시각을 포함하여 해제 요청을 보냅니다. 결제 서버는 보정된 시각이 오차범위 내(기본 값: 10초)라면 클라이언트의 "out of sync" 상태를 해제합니다.

## Server

### Time-step window

Time step window는 클라이언트와 결제 서바 간의 시간 오차나 네트워크 지연 등으로 카운터 계산에 차이가 발생하는 경우를 방지하기 위해 사용됩니다.

Time-step window에 관해선 [RFC6238#section-5.2](https://datatracker.ietf.org/doc/html/rfc6238#section-5.2)를 참고해주세요.

```text
  ──┐┌──     30s     ──┐┌──     30s     ──┐┌──     30s     ──┐
    }{      506440     }{      506441     }{      506442     }
window ─┘            └─── time-step window ───┘            └──
```

구현에 따라 달라질 수 있지만, 사양은 ±10초를 기본값으로 정합니다.

다음 카운터 까지 남은 시간은 다음 식으로 계산할 수 있습니다.

$$
L = 30\cdot1000-((T-T_{0})\bmod30\cdot1000)
$$

이전 카운터로부터 지난 시간은 다음 식으로 계산할 수 있습니다.

$$
L = T-30\cdot1000\cdot{C}
$$


### 토큰 검증

토큰 검증은 다음 순서를 따릅니다.

1. base45 인코딩 확인 및 메타데이터 검증
2. 일반 페이로드 파싱
3. 암호화 페이로드 복호화 및 MAC 검증
4. 암호화 페이로드 파싱
5. Nonce 검증
6. Auth Token 및 Device ID 검증

### 메타데이터 검증

토큰이 로컬 생성 결제 토큰인지 빠르게 확인하기 위해선 체크썸으로 [페이로드 포맷 지시자](./1-Payload.md#payload-format-indicator)와 [애플리케이션 식별자](./1-Payload.md#application-identifier)를 Base45로 인코딩한 값을 사용할 수 있습니다.

애플리케이션 식별자가 `0x44 0x40 0xff 0xff`이라면 채크썸은 `6T9SS8FGW`입니다. 두 값은 2n 바이트이기 때문에 항상 Base45 인코딩 값을 미리 알 수 있습니다.

### Nonce 저장

Nonce를 TTL로 저장한다면, 경계값에 안전하기 위해 카운터가 업데이트 되기까지 남은 시간 보다 1~2초 정도 더 길제 저장하는 것이 좋습니다.
